# راهنمای سیستم لایسنس آفلاین

## 🔐 معرفی سیستم

سیستم لایسنس آفلاین برای کنترل دسترسی و استفاده از نرمافزار طراحی شده است. این سیستم کاملاً آفلاین عمل کرده و نیازی به اتصال اینترنت ندارد.

## 🏗️ معماری سیستم

### کامپوننتهای اصلی:
1. **LicenseManager.php** - کلاس اصلی مدیریت لایسنس
2. **license_admin.php** - پنل مدیریت لایسنس (فقط سوپر ادمین)
3. **license_check.php** - بررسی خودکار لایسنس در هر صفحه
4. **system_license** - جدول دیتابیس ذخیره اطلاعات لایسنس

## 📋 ویژگیهای سیستم

### ✅ ویژگیهای پیادهسازی شده:
- تولید شناسه یونیک سیستم (Hardware ID)
- تولید و رمزگذاری کلید لایسنس
- فعالسازی لایسنس با اعتبارسنجی
- بررسی خودکار اعتبار در هر اجرا
- کنترل تعداد کاربران مجاز
- مدیریت ویژگیهای مجاز
- تمدید، غیرفعالسازی و بازنشانی لایسنس
- هشدار انقضای نزدیک

## 🚀 نصب و راهاندازی

### مرحله 1: کپی فایلها
فایلهای زیر را در پروژه قرار دهید:
```
includes/LicenseManager.php
includes/license_check.php
license_admin.php
license_test.php
```

### مرحله 2: بروزرسانی header.php
فایل `includes/header.php` بهروزرسانی شده تا بررسی لایسنس را شامل شود.

### مرحله 3: ایجاد جدول دیتابیس
جدول `system_license` خودکار ایجاد میشود، اما میتوانید دستی اجرا کنید:

```sql
CREATE TABLE system_license (
    id INT PRIMARY KEY AUTO_INCREMENT,
    hardware_id VARCHAR(255) UNIQUE NOT NULL,
    license_key VARCHAR(500) NOT NULL,
    status ENUM('active', 'expired', 'disabled') DEFAULT 'active',
    issued_date DATETIME NOT NULL,
    expiry_date DATETIME NOT NULL,
    max_users INT DEFAULT 5,
    features JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 🔧 نحوه استفاده

### برای سوپر ادمین:

#### 1. دسترسی به پنل مدیریت:
```
http://localhost/motor/license_admin.php
```

#### 2. تولید لایسنس جدید:
- وارد کردن مدت اعتبار (روز)
- تعیین حداکثر کاربران
- انتخاب ویژگیهای مجاز
- کلیک روی "تولید کلید لایسنس"

#### 3. فعالسازی لایسنس:
- کپی کلید لایسنس تولید شده
- وارد کردن در قسمت "فعالسازی لایسنس"
- کلیک روی "فعالسازی لایسنس"

#### 4. مدیریت لایسنس فعلی:
- غیرفعال کردن لایسنس
- تمدید لایسنس (افزودن روز)
- بازنشانی کامل لایسنس

### برای کاربران عادی:
- سیستم خودکار بررسی میکند
- در صورت مشکل، پیام خطا نمایش داده میشود
- کاربران عادی نمیتوانند لایسنس را مدیریت کنند

## 🧪 تست سیستم

### اجرای تست خودکار:
```
http://localhost/motor/license_test.php
```

### تستهای انجام شده:
1. تولید Hardware ID
2. تولید کلید لایسنس
3. فعالسازی لایسنس
4. اعتبارسنجی لایسنس
5. بررسی ویژگیها
6. محدودیت کاربران
7. تمدید لایسنس
8. غیرفعالسازی
9. بازنشانی

## 🔒 امنیت سیستم

### ویژگیهای امنیتی:
- **رمزگذاری AES-256-CBC** برای کلیدهای لایسنس
- **Hardware ID یونیک** برای هر سیستم
- **اعتبارسنجی CSRF** در پنل مدیریت
- **محدودیت دسترسی** فقط برای سوپر ادمین
- **بررسی خودکار** در هر صفحه

### نکات امنیتی:
- کلیدهای لایسنس فقط روی سیستم مقصد کار میکنند
- تغییر Hardware ID باعث غیرفعال شدن لایسنس میشود
- اطلاعات لایسنس در دیتابیس محلی ذخیره میشود

## 📊 مدیریت ویژگیها

### ویژگیهای پیشفرض:
- `advanced_reports` - گزارشات پیشرفته
- `multi_branch` - چند شعبه
- `api_access` - دسترسی API

### اضافه کردن ویژگی جدید:
```php
// در کد خود
if ($licenseManager->hasFeature('new_feature')) {
    // اجرای ویژگی
}
```

## 🚨 عیبیابی

### مشکلات رایج:

#### 1. خطای "لایسنس یافت نشد":
- بررسی وجود جدول `system_license`
- اجرای `license_test.php` برای تشخیص مشکل

#### 2. خطای "لایسنس برای این سیستم صادر نشده":
- Hardware ID تغییر کرده است
- نیاز به تولید لایسنس جدید

#### 3. خطای "لایسنس منقضی شده":
- تاریخ انقضا گذشته است
- استفاده از تمدید لایسنس

#### 4. خطای رمزگذاری:
- بررسی نصب OpenSSL در PHP
- بررسی کلید رمزگذاری

### لاگهای سیستم:
خطاهای لایسنس در فایل error log ذخیره میشوند:
```
logs/error_*.log
```

## 📈 گسترش سیستم

### اضافه کردن ویژگیهای جدید:

#### 1. تعریف ویژگی در پنل مدیریت:
```html
<div class="form-check">
    <input class="form-check-input" type="checkbox" name="features[]" value="new_feature" id="f4">
    <label class="form-check-label" for="f4">ویژگی جدید</label>
</div>
```

#### 2. بررسی ویژگی در کد:
```php
if ($licenseManager->hasFeature('new_feature')) {
    // کد ویژگی جدید
}
```

### تغییر محدودیتها:
```php
// تغییر حداکثر کاربران
$licenseManager->extendLicense($hardwareId, 0); // بدون تمدید
// سپس بهروزرسانی max_users در دیتابیس
```

## 📞 پشتیبانی

### فایلهای مهم:
- `includes/LicenseManager.php` - کلاس اصلی
- `license_admin.php` - پنل مدیریت
- `license_test.php` - تست سیستم

### دستورات مفید:
```sql
-- مشاهده اطلاعات لایسنس
SELECT * FROM system_license;

-- بازنشانی لایسنس
DELETE FROM system_license;

-- تغییر وضعیت لایسنس
UPDATE system_license SET status = 'active' WHERE id = 1;
```

---

## ✅ چکلیست راهاندازی

- [ ] کپی فایلهای سیستم لایسنس
- [ ] بهروزرسانی header.php
- [ ] تست اتصال دیتابیس
- [ ] اجرای `license_test.php`
- [ ] تولید لایسنس اولیه
- [ ] فعالسازی لایسنس
- [ ] تست عملکرد کامل سیستم

**سیستم لایسنس آماده استفاده است! 🎉**